<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ESP32 Sniffer Console — Debug</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --bg: #0f1720;
        --card: #0b1220;
        --accent: #00d084;
        --muted: #94a3b8;
        --danger: #ff6b6b;
        --glass: rgba(255, 255, 255, 0.03);
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, "Helvetica Neue", Arial;
      }
      body {
        background: linear-gradient(180deg, #071018 0%, #071a1f 60%);
        color: #e6eef6;
        padding: 18px;
        box-sizing: border-box;
      }
      header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
      }
      h1 {
        font-size: 18px;
        margin: 0;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-left: auto;
      }
      button {
        background: var(--glass);
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--accent);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(90deg, #042f2a, #004d3e);
        color: #fff;
        border: 0;
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.03);
      }
      main {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 12px;
        height: calc(100vh - 110px);
      }
      .left {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .status {
        padding: 10px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--muted);
        font-size: 13px;
      }
      .filters {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      label {
        font-size: 12px;
        color: var(--muted);
      }
      input,
      select {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        background: #08131a;
        color: #e6eef6;
      }
      #packetList {
        height: 100%;
        overflow: auto;
        font-family: monospace;
        font-size: 12px;
        padding: 8px;
        border-radius: 8px;
        background: #041018;
      }
      .pkt {
        padding: 6px;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.02);
      }
      .pkt .meta {
        color: var(--muted);
        font-size: 11px;
      }
      .topbar {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .toasts {
        position: fixed;
        right: 16px;
        bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 900;
      }
      .toast {
        padding: 10px 14px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: #e6eef6;
      }
      .error {
        border-left: 4px solid var(--danger);
      }
      .ok {
        border-left: 4px solid var(--accent);
      }
      .sendRow {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      textarea#log {
        width: 100%;
        height: 160px;
        border-radius: 8px;
        padding: 8px;
        background: #02060a;
        color: #8ff6b3;
        border: 1px solid rgba(255, 255, 255, 0.02);
        resize: vertical;
        font-family: monospace;
      }
      .debug {
        font-family: monospace;
        font-size: 12px;
        color: var(--muted);
        background: rgba(0, 0, 0, 0.2);
        padding: 8px;
        border-radius: 6px;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .right-col {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
      }
      .muted {
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ESP32 Sniffer Console — Debug</h1>
      <div class="controls">
        <button id="connectSerial">Connect USB Serial</button>
        <button id="connectBLE" class="primary">Connect BLE (NUS)</button>
        <button id="connectBT">Classic BT (SPP)</button>
      </div>
    </header>

    <main>
      <div class="left card">
        <div class="status" id="status">
          Status: <span id="statusText">Idle — not connected</span>
        </div>

        <div class="card filters" style="gap: 6px">
          <div class="row">
            <label style="width: 72px">Frame type</label>
            <select id="ftype">
              <option value="">All</option>
              <option value="Mgmt">Mgmt</option>
              <option value="Ctrl">Ctrl</option>
              <option value="Data">Data</option>
              <option value="Beacon">Beacon</option>
            </select>
          </div>

          <div class="row">
            <label style="width: 72px">MAC filter</label
            ><input id="macFilter" placeholder="e.g. 12:34 or A4:5E" />
          </div>
          <div class="row">
            <label style="width: 72px">Min RSSI</label
            ><input id="rssiFilter" type="number" placeholder="-120" />
          </div>
          <div class="row">
            <label style="width: 72px">Channel</label
            ><input
              id="channelFilter"
              type="number"
              min="1"
              max="13"
              placeholder="(all)"
            />
          </div>

          <div style="display: flex; gap: 8px">
            <button id="applyFilters">Apply</button>
            <button id="clearFilters">Clear</button>
          </div>
        </div>

        <div
          class="card"
          style="display: flex; flex-direction: column; gap: 8px"
        >
          <div
            style="
              display: flex;
              gap: 8px;
              align-items: center;
              justify-content: space-between;
            "
          >
            <div>
              <button id="cmdStart">Start</button>
              <button id="cmdStop">Stop</button>
              <button id="cmdToggleHop">Hop Toggle</button>
              <button id="cmdStatus">Get Status</button>
            </div>
            <div class="small muted">
              Commands: START, STOP, HOP ON|OFF|TOGGLE, SET_CH N, FILTER ADD
              &lt;mac&gt;, FILTER CLR, RSSI_MIN &lt;v&gt;, GET_STATUS
            </div>
          </div>

          <div>
            <label class="small">Manual command</label>
            <div class="sendRow">
              <input id="manualCmd" placeholder="e.g. SET_CH 6" />
              <button id="sendCmd">Send</button>
              <button id="clearPackets">Clear Packets</button>
            </div>
          </div>

          <div>
            <label class="small">Raw log</label>
            <textarea id="log" readonly></textarea>
            <div
              style="
                display: flex;
                gap: 8px;
                margin-top: 6px;
                align-items: center;
              "
            >
              <button id="clearLog">Clear Log</button>
              <label class="small muted">Autoscroll</label
              ><input id="autoscroll" type="checkbox" checked />
              <label class="small muted">JSON output</label
              ><input id="jsonOut" type="checkbox" />
            </div>
          </div>
        </div>

        <div class="card debug">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <strong>Debug</strong>
            <button id="toggleDebug">Hide</button>
          </div>
          <div
            style="
              margin-top: 8px;
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 8px;
            "
          >
            <div>
              <div class="small muted">Connection</div>
              <div id="connType">none</div>
              <div class="small muted">Counters</div>
              <div>
                Packets: <span id="pktCount">0</span> • Raw lines:
                <span id="rawCount">0</span> • JSON errs:
                <span id="jsonErr">0</span>
              </div>
            </div>
            <div>
              <div class="small muted">Last raw</div>
              <div id="lastRaw" style="word-break: break-all"></div>
              <div class="small muted" style="margin-top: 8px">
                Last parse error
              </div>
              <div id="lastParseErr"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="right-col card">
        <div class="toolbar">
          <div><strong>Packet Stream</strong></div>
          <div style="display: flex; gap: 8px">
            <button id="exportJSON">Export JSON</button>
            <button id="exportText">Export Text</button>
          </div>
        </div>
        <div id="packetList" style="margin-top: 8px"></div>
      </div>
    </main>

    <div class="toasts" id="toasts"></div>

    <script>
      /* ---------- Helpers & UI ---------- */
      const toastArea = document.getElementById("toasts");
      function toast(msg, kind = "ok", ttl = 4000) {
        const el = document.createElement("div");
        el.className = "toast " + (kind === "error" ? "error" : "ok");
        el.textContent = msg;
        toastArea.appendChild(el);
        setTimeout(() => el.remove(), ttl);
      }
      function logRaw(s) {
        const ta = document.getElementById("log");
        ta.value += s + "\n";
        ta.scrollTop = ta.scrollHeight;
      }
      function setStatus(s) {
        document.getElementById("statusText").textContent = s;
      }
      function setConnType(s) {
        document.getElementById("connType").textContent = s;
      }

      /* ---------- State ---------- */
      let serialPort = null,
        serialWriter = null,
        serialReader = null;
      let bleDevice = null,
        bleServer = null,
        bleTxChar = null,
        bleRxChar = null;
      let connBackend = null; // 'serial' | 'ble' | null
      const NUS_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
      const NUS_RX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
      const NUS_TX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

      let recvBuffer = "";
      let rows = [];
      let counters = { packets: 0, raw: 0, jsonErr: 0 };

      /* ---------- Data decode helpers ---------- */
      function decodeDataViewOrBuffer(v) {
        // handle DataView (notifications) safely taking into account byteOffset/byteLength
        try {
          if (v instanceof DataView) {
            const ab = v.buffer.slice(
              v.byteOffset,
              v.byteOffset + v.byteLength
            );
            return new TextDecoder().decode(ab);
          }
          if (v instanceof ArrayBuffer) {
            return new TextDecoder().decode(v);
          }
          // fallback - if it's already a string
          return String(v);
        } catch (e) {
          console.warn("decode error", e);
          return "";
        }
      }

      /* ---------- Packet display & filters ---------- */
      function addPacket(pkt) {
        // expected keys: ts, chan, rssi, type, subtype, src, dst, bssid
        const ftype = document.getElementById("ftype").value;
        const macf = document
          .getElementById("macFilter")
          .value.trim()
          .toLowerCase();
        const rssiMin = parseInt(
          document.getElementById("rssiFilter").value || "-999"
        );
        const chFilter = parseInt(
          document.getElementById("channelFilter").value || "0"
        );

        if (ftype && !(pkt.type == ftype || pkt.subtype == ftype)) return;
        if (macf) {
          const matches = (
            (pkt.src || "") +
            " " +
            (pkt.dst || "") +
            " " +
            (pkt.bssid || "")
          ).toLowerCase();
          if (!matches.includes(macf)) return;
        }
        if (typeof pkt.rssi === "number" && pkt.rssi < rssiMin) return;
        if (chFilter && pkt.chan !== chFilter) return;

        rows.unshift(pkt);
        counters.packets++;
        document.getElementById("pktCount").textContent = counters.packets;
        renderList();
      }

      function renderList() {
        const el = document.getElementById("packetList");
        el.innerHTML = "";
        for (const p of rows) {
          const div = document.createElement("div");
          div.className = "pkt";
          const meta = `${p.ts} ms  CH:${String(p.chan).padStart(
            2,
            " "
          )}  RSSI:${p.rssi} dBm  ${p.type}${p.subtype ? "/" + p.subtype : ""}`;
          div.innerHTML = `<div style="font-weight:600">${p.src || "--"} → ${
            p.dst || "--"
          } <span style="float:right;color:var(--muted)">${
            p.bssid || ""
          }</span></div>
                     <div class="meta">${meta}</div>
                     <div style="color:var(--muted);font-size:12px">${
                       p.info || ""
                     }</div>`;
          el.appendChild(div);
        }
        // newest entries are at top so show top if autoscroll
        if (document.getElementById("autoscroll").checked) el.scrollTop = 0;
      }

      /* ---------- Receiving / parsing ---------- */
      function receiveLineChunk(chunk) {
        // unify chunk to string
        recvBuffer += chunk;
        const lines = recvBuffer.split(/\r?\n/);
        recvBuffer = lines.pop(); // remainder
        for (const ln of lines) {
          if (ln.length === 0) continue;
          counters.raw++;
          document.getElementById("rawCount").textContent = counters.raw;
          document.getElementById("lastRaw").textContent = ln;
          logRaw(ln);

          // try parse JSON if checkbox enabled OR try regardless to populate packets
          let parsed = null;
          try {
            parsed = JSON.parse(ln);
            addPacket(parsed);
          } catch (e) {
            // if JSON checkbox is on, count error, otherwise just ignore parse
            if (document.getElementById("jsonOut").checked) {
              counters.jsonErr++;
              document.getElementById("jsonErr").textContent = counters.jsonErr;
              document.getElementById("lastParseErr").textContent =
                e.message + " (line truncated?)";
            }
          }
        }
      }

      /* ---------- Web Serial ---------- */
      async function connectSerial() {
        try {
          if (!("serial" in navigator)) {
            toast("Web Serial not available in this browser", "error");
            return;
          }
          serialPort = await navigator.serial.requestPort();
          await serialPort.open({ baudRate: 115200 });
          setStatus("Connected (USB Serial)");
          setConnType("USB Serial");
          connBackend = "serial";
          toast("Serial connected");

          serialWriter = serialPort.writable.getWriter();
          // reader pipeline
          const textDecoder = new TextDecoderStream();
          serialPort.readable.pipeTo(textDecoder.writable);
          serialReader = textDecoder.readable.getReader();
          readSerialLoop();
        } catch (e) {
          toast("Serial connection failed: " + e, "error", 6000);
          console.error(e);
        }
      }

      async function readSerialLoop() {
        try {
          while (true) {
            const { value, done } = await serialReader.read();
            if (done) break;
            if (value) receiveLineChunk(value);
          }
        } catch (e) {
          toast("Serial read error: " + e, "error");
          console.error(e);
        } finally {
          // cleanup
          try {
            if (serialReader) {
              await serialReader.cancel();
              serialReader.releaseLock();
            }
          } catch (e) {}
          try {
            if (serialWriter) serialWriter.releaseLock();
          } catch (e) {}
          try {
            await serialPort.close();
          } catch (e) {}
          setStatus("Disconnected");
          setConnType("none");
          connBackend = null;
        }
      }

      /* ---------- Web Bluetooth (NUS) ---------- */
      async function connectBLE() {
        try {
          if (!navigator.bluetooth) {
            toast("Web Bluetooth not available in this browser", "error");
            return;
          }
          const dev = await navigator.bluetooth.requestDevice({
            filters: [{ services: [NUS_SERVICE] }],
            optionalServices: [NUS_SERVICE],
          });
          bleDevice = dev;
          setStatus("Connecting BLE...");
          setConnType("BLE");
          connBackend = "ble";
          bleServer = await dev.gatt.connect();
          const svc = await bleServer.getPrimaryService(NUS_SERVICE);

          // get TX (notify) and RX (write)
          try {
            bleTxChar = await svc.getCharacteristic(NUS_TX);
            bleRxChar = await svc.getCharacteristic(NUS_RX);
          } catch (err) {
            toast("Could not find NUS characteristics: " + err, "error", 7000);
            setStatus("BLE error: missing NUS chars");
            console.error(err);
            return;
          }

          // start notifications
          await bleTxChar.startNotifications();
          bleTxChar.addEventListener("characteristicvaluechanged", (ev) => {
            const v = ev.target.value; // DataView
            const s = decodeDataViewOrBuffer(v);
            receiveLineChunk(s);
          });

          // show details
          setStatus("Connected (BLE: " + (dev.name || "ESP32") + ")");
          toast("BLE connected to " + (dev.name || "ESP32"));
        } catch (e) {
          toast("BLE connect failed: " + e, "error", 6000);
          console.error(e);
          setStatus("BLE connect failed");
          setConnType("none");
          connBackend = null;
        }
      }

      /* ---------- Send to device ---------- */
      async function sendToDevice(text) {
        if (!text) return false;
        if (connBackend === "serial" && serialWriter) {
          try {
            const data = new TextEncoder().encode(text + "\n");
            await serialWriter.write(data);
            toast("Sent via Serial: " + text, "ok", 1300);
            return true;
          } catch (e) {
            toast("Serial write failed: " + e, "error");
            console.error(e);
            return false;
          }
        } else if (connBackend === "ble" && bleRxChar) {
          try {
            const enc = new TextEncoder().encode(text + "\n");
            // chunk to 20 bytes
            let i = 0;
            while (i < enc.length) {
              const slice = enc.slice(i, i + 20);
              await bleRxChar.writeValue(slice);
              i += slice.length;
            }
            toast("Sent via BLE: " + text, "ok", 1300);
            return true;
          } catch (e) {
            toast("BLE write failed: " + e, "error", 4000);
            console.error(e);
            return false;
          }
        } else {
          toast("Not connected (no backend)", "error");
          return false;
        }
      }

      /* ---------- UI wiring ---------- */
      document.getElementById("connectSerial").onclick = connectSerial;
      document.getElementById("connectBLE").onclick = connectBLE;
      document.getElementById("connectBT").onclick = () => {
        toast(
          "Classic SPP cannot be used from the web. Use an Android/PC SPP app.",
          "error",
          7000
        );
      };

      document.getElementById("sendCmd").onclick = async () => {
        const v = document.getElementById("manualCmd").value.trim();
        if (!v) return;
        await sendToDevice(v);
        document.getElementById("manualCmd").value = "";
      };
      document.getElementById("cmdStart").onclick = () => sendToDevice("START");
      document.getElementById("cmdStop").onclick = () => sendToDevice("STOP");
      document.getElementById("cmdToggleHop").onclick = () =>
        sendToDevice("HOP TOGGLE");
      document.getElementById("cmdStatus").onclick = () =>
        sendToDevice("GET_STATUS");
      document.getElementById("applyFilters").onclick = () => {
        renderList();
        toast("Filters applied");
      };
      document.getElementById("clearFilters").onclick = () => {
        document.getElementById("ftype").value = "";
        document.getElementById("macFilter").value = "";
        document.getElementById("rssiFilter").value = "";
        document.getElementById("channelFilter").value = "";
        renderList();
        toast("Filters cleared");
      };
      document.getElementById("clearLog").onclick = () => {
        document.getElementById("log").value = "";
        toast("Log cleared");
      };
      document.getElementById("clearPackets").onclick = () => {
        rows = [];
        counters.packets = 0;
        document.getElementById("pktCount").textContent = "0";
        renderList();
        toast("Packets cleared");
      };
      document.getElementById("toggleDebug").onclick = () => {
        const dbg = document.querySelector(".debug");
        dbg.style.display = dbg.style.display === "none" ? "block" : "none";
        document.getElementById("toggleDebug").textContent =
          dbg.style.display === "none" ? "Show" : "Hide";
      };
      document.getElementById("exportJSON").onclick = () => {
        const blob = new Blob([JSON.stringify(rows, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "packets.json";
        a.click();
        URL.revokeObjectURL(url);
      };
      document.getElementById("exportText").onclick = () => {
        const txt = rows.map((r) => JSON.stringify(r)).join("\\n");
        const blob = new Blob([txt], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "packets.txt";
        a.click();
        URL.revokeObjectURL(url);
      };

      /* ---------- graceful unload ---------- */
      window.addEventListener("beforeunload", async () => {
        try {
          if (serialReader) {
            await serialReader.cancel();
            serialReader.releaseLock();
          }
          if (serialWriter) serialWriter.releaseLock();
          if (serialPort) await serialPort.close();
          if (bleServer && bleServer.connected) bleServer.disconnect();
        } catch (e) {}
      });

      /* ---------- initial helpful hint ---------- */
      toast(
        'Tip: Use "Connect BLE" for Web Bluetooth (NUS). For Classic Bluetooth use a native app.',
        "ok",
        7000
      );
      setStatus("Idle — ready");
    </script>
  </body>
</html>
