<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ESP32 Serial Terminal</title>
    <style>
      body {
        font-family: monospace;
        background: #111;
        color: #0f0;
      }
      #log {
        width: 100%;
        height: 300px;
        background: #000;
        color: #0f0;
      }
      button,
      input {
        margin: 5px;
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <h1>ESP32 Serial Terminal</h1>
    <button id="connect">Connect</button>
    <input id="input" placeholder="Type command..." />
    <button id="send">Send</button>
    <br />
    <textarea id="log" readonly></textarea>

    <script>
      let port, writer, reader;

      async function connect() {
        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });

          // Set up writer
          writer = port.writable.getWriter();

          // Set up reader
          const decoder = new TextDecoderStream();
          port.readable.pipeTo(decoder.writable);
          reader = decoder.readable.getReader();

          // Read loop
          readLoop();
        } catch (err) {
          alert("Connection failed: " + err);
        }
      }

      async function readLoop() {
        const log = document.getElementById("log");
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            log.value += value;
            log.scrollTop = log.scrollHeight;
          }
        }
      }

      async function send() {
        const input = document.getElementById("input");
        if (!writer) return;
        const data = input.value + "\n";
        await writer.write(new TextEncoder().encode(data));
        input.value = "";
      }

      document.getElementById("connect").addEventListener("click", connect);
      document.getElementById("send").addEventListener("click", send);
    </script>
  </body>
</html>
